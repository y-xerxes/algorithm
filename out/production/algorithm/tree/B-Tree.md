# 平衡多路查找树 B-Tree
B-Tree是为磁盘等外存储设备设计的一种平衡查找树。
系统从磁盘读取数据到内存是以磁盘块block为基本单位，位于同一block的数据会被一次性读出来。
InnoDB从磁盘读取数据时以页为基本单位，查询数据时如果一个页中的每条数据都有助于定位数据记录的位置，将大大减少磁盘I/O次数。
B-Tree结构的数据可以让系统高效的找到数据所在的磁盘块。
## 索引
索引本身也很大，不可能全部存储在内存中，因此索引往往以文件的形式存储在磁盘上。索引查找过程产生磁盘I/O，所以索引的结果需要尽量减少磁盘I/O。
## 磁盘存取原理
**一个磁盘由大小相同且同轴的圆形盘片组成**，磁盘可以转动（各个磁盘必须同步转动）。
**在磁盘的一侧有磁头支架，磁头支架固定了一组磁头**，每个磁头负责存取一个磁盘的内容。
**每个同心环叫做一个扇区: 磁盘的最小存储单元**。
当需要从磁盘读取数据时，系统会将数据逻辑地址传给磁盘，磁盘的控制电路按照寻址逻辑将逻辑地址翻译成物理地址，即确定要读的数据在哪个磁道，哪个扇区。为了读取这个扇区的数据，需要将磁头放到这个扇区上方，为了实现这一点，磁头需要移动对准相应磁道，这个过程叫做寻道，所耗费时间叫做寻道时间，然后磁盘旋转将目标扇区旋转到磁头下，这个过程耗费的时间叫做旋转时间。
## 局部性原理与磁盘预读
磁盘往往不是严格按需读取，而是每次都会**预读**，即使只需要一个字节，磁盘也会从这个位置开始，**顺序向后读取一定长度的数据放入内存**。预读可以提高I/O效率。
预读的长度一般为页（page:计算机管理存储器的逻辑块-通常为4k）的整倍数. 主存和磁盘以页为单位交换数据。当程序要读取的数据不在主存中时，会触发一个缺页异常，此时系统会向磁盘发出读盘信号，磁盘会找到数据的起始位置并向后连续读取一页或几页载入内存中。
## 一颗m阶B-Tree的特性
- 每个节点最多有m个孩子
- 除了根节点和叶子节点外，其他每个节点至少有ceil(m/2)个孩子
- 若根节点不是叶子节点，则至少有2个孩子
- 所有叶子节点都在同一层，且不包含其他key信息
- 每个非终端节点包含n个key，key的个数n满足：ceil(m/2) \<= n \<= m-1
- key升序排序
- 指针指向的子树的所有节点key均小于指针右边的key，并且都大于指针左边的key。
![](/Users/xerxes/Development/algorithm/resources/B-Tree.jpg)
每个节点占用一个磁盘块，指针存储的是子节点所在磁盘块的地址。节点的key划分的范围域对应指针指向的子树的数据的范围域。
B-Tree的问题：每个节点不仅包含key还包含data。每一个页的存储空间是有限的，如果data太大会导致每个节点存的key少，导致B-Tree深度大。